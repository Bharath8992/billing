{% extends "invoice/base/base.html" %}
{% load static %}
{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex flex-column flex-md-row justify-content-between align-items-center">
        <label class="m-0 font-weight-bold text-primary mb-2 mb-md-0">Create Invoice</label>
        <div class="d-flex flex-wrap justify-content-center">
          <span class="badge badge-primary mr-2 mb-1">Services: {{ total_product }}</span>
          <span class="badge badge-primary mb-1">Invoices: {{ total_invoice }}</span>
        </div>
      </div>

      <div class="card-body">
        <form method="post" action="{% url 'create_invoice' %}" id="invoiceForm">
          {% csrf_token %}
          
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}danger{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert">
                  <span>&times;</span>
                </button>
              </div>
            {% endfor %}
          {% endif %}

          <!-- Customer Selection -->
          <div class="mb-4">
            <div class="card">
              <div class="card-header bg-primary text-white d-flex align-items-center">
                <i class="fas fa-user mr-2"></i>
                <h6 class="mb-0 flex-grow-1">Customer Information</h6>
              </div>
              <div class="card-body">
                <!-- Mobile-friendly Tabs -->
                <ul class="nav nav-tabs mb-3" id="customerTab" role="tablist">
                  <li class="nav-item flex-grow-1 text-center">
                    <a class="nav-link active" id="existing-tab" data-toggle="tab" href="#existing">
                      <i class="fas fa-search d-block d-md-inline mb-1 mb-md-0 mr-md-2"></i>
                      <span class="d-none d-md-inline">Search Existing</span>
                      <span class="d-md-none">Existing</span>
                    </a>
                  </li>
                  <li class="nav-item flex-grow-1 text-center">
                    <a class="nav-link" id="new-tab" data-toggle="tab" href="#new">
                      <i class="fas fa-user-plus d-block d-md-inline mb-1 mb-md-0 mr-md-2"></i>
                      <span class="d-none d-md-inline">Create New</span>
                      <span class="d-md-none">New</span>
                    </a>
                  </li>
                </ul>
                
                <div class="tab-content" id="customerTabContent">
                  <!-- Existing Customer Tab -->
                  <div class="tab-pane fade show active" id="existing" role="tabpanel">
                    <div class="form-group">
                      <label class="font-weight-bold">Search & Select Customer</label>
                      <select id="customer_select" class="form-control select2-customers">
                        <option value=""></option>
                        <!-- Initial options -->
                        {% for customer in customers %}
                        <option value="{{ customer.id }}" 
                                data-name="{{ customer.customer_name }}"
                                data-number="{{ customer.customer_number }}"
                                data-gender="{{ customer.customer_gender|default:'Male' }}"
                                data-status="{{ customer.customer_status|default:'Normal' }}">
                          {{ customer.customer_name }} - {{ customer.customer_number }}
                          ({{ customer.customer_status }})
                        </option>
                        {% endfor %}
                      </select>
                      <small class="form-text text-muted">
                        <i class="fas fa-info-circle"></i> Optional - Select existing customer or create new one below
                      </small>
                      <!-- Hidden input for existing customer ID -->
                      <input type="hidden" id="selected_customer_id" name="selected_customer_id">
                      <!-- Hidden input for customer status -->
                      <input type="hidden" id="customer_status_value" name="customer_status" value="Normal">
                    </div>
                    
                    <!-- Customer Details Card -->
                    <div class="card mt-3" id="customerDetailsCard" style="display: none;">
                      <div class="card-header bg-light d-flex align-items-center">
                        <i class="fas fa-user-circle mr-2"></i>
                        <h6 class="mb-0 flex-grow-1">Selected Customer Details</h6>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-6">
                            <div class="form-group">
                              <label class="text-muted">Full Name</label>
                              <input id="customer_name_display" type="text" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                              <label class="text-muted">Mobile Number</label>
                              <input id="customer_number" type="text" class="form-control" readonly>
                            </div>
                          </div>
                          <div class="col-md-6">
                            <div class="form-group">
                              <label class="text-muted">Gender</label>
                              <input id="customer_gender" type="text" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                              <label class="text-muted">Status</label>
                              <input id="customer_status" type="text" class="form-control" readonly>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- New Customer Tab (Now Optional) -->
                  <div class="tab-pane fade" id="new" role="tabpanel">
                    <div class="alert alert-info mb-3">
                      <i class="fas fa-info-circle mr-2"></i>
                      All fields are optional. You can create invoice without customer details.
                    </div>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="font-weight-bold">Full Name</label>
                          <input type="text" name="new_customer_name" class="form-control" 
                                 value="{{ request.POST.new_customer_name|default:'' }}">
                          <small class="text-muted">Optional</small>
                        </div>
                        <div class="form-group">
                          <label class="font-weight-bold">Gender</label>
                          <select name="new_customer_gender" class="form-control">
                            <option value="Male" {% if request.POST.new_customer_gender == 'Male' or not request.POST.new_customer_gender %}selected{% endif %}>Male</option>
                            <option value="Female" {% if request.POST.new_customer_gender == 'Female' %}selected{% endif %}>Female</option>
                            <option value="Others" {% if request.POST.new_customer_gender == 'Others' %}selected{% endif %}>Others</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="font-weight-bold">Mobile Number</label>
                          <input type="text" name="new_customer_mobile" class="form-control" 
                                 value="{{ request.POST.new_customer_mobile|default:'' }}"
                                 pattern="[0-9]{10}" title="10 digit mobile number">
                          <small class="text-muted">Optional - 10 digits</small>
                        </div>
                        <div class="form-group">
                          <label class="font-weight-bold">Customer Status</label>
                          <select name="new_customer_status" class="form-control" id="new_customer_status">
                            <option value="Normal" {% if request.POST.new_customer_status == 'Normal' or not request.POST.new_customer_status %}selected{% endif %}>Normal</option>
                            <option value="Membership" {% if request.POST.new_customer_status == 'Membership' %}selected{% endif %}>Membership</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Price Type Selection (Only shows when customer is Membership) -->
          <div class="mb-4" id="priceTypeSection" style="display: none;">
            <div class="card">
              <div class="card-header bg-warning text-white d-flex align-items-center">
                <i class="fas fa-tag mr-2"></i>
                <h6 class="mb-0 flex-grow-1">Price Type Selection</h6>
              </div>
              <div class="card-body">
                <div class="alert alert-info">
                  <i class="fas fa-info-circle mr-2"></i>
                  This customer has <strong>Membership</strong> status. You can choose to use either regular prices or membership prices.
                </div>
                <div class="form-group">
                  <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" id="priceTypeRegular" name="price_type" value="regular" class="custom-control-input" checked>
                    <label class="custom-control-label font-weight-bold" for="priceTypeRegular">
                      Regular Price
                      <small class="text-muted d-block">Use standard service prices</small>
                    </label>
                  </div>
                  <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" id="priceTypeMembership" name="price_type" value="membership" class="custom-control-input">
                    <label class="custom-control-label font-weight-bold" for="priceTypeMembership">
                      Membership Price
                      <small class="text-muted d-block">Use discounted membership prices</small>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Comments -->
          <div class="mb-4">
            <div class="card">
              <div class="card-header d-flex align-items-center">
                <i class="fas fa-comment mr-2"></i>
                <h6 class="mb-0 flex-grow-1">Comments (Optional)</h6>
              </div>
              <div class="card-body">
                <textarea name="comments" class="form-control" rows="2" 
                          placeholder="Any special instructions or notes...">{{ request.POST.comments|default:'' }}</textarea>
              </div>
            </div>
          </div>

          <!-- Service Selection - Mobile Responsive with Carousel -->
          <div class="mb-4">
            <div class="card">
              <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                <div class="d-flex align-items-center mb-2 mb-md-0">
                  <i class="fas fa-spa mr-2"></i>
                  <h6 class="mb-0">Select Services *</h6>
                </div>
                <div class="d-flex align-items-center w-100 w-md-auto">
                  <div class="input-group input-group-sm mr-2 flex-grow-1 flex-md-grow-0" style="min-width: 200px;">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="fas fa-search"></i></span>
                    </div>
                    <input type="text" class="form-control" id="serviceSearch" placeholder="Search services...">
                    <div class="input-group-append">
                      <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <span class="badge badge-info d-none d-md-inline">Total: {{ products|length }}</span>
                </div>
              </div>
              
              <div class="card-body p-0 p-md-3">
                {% if products %}
                  <!-- Desktop View (Grid) -->
                  <div class="d-none d-md-block">
                    <div class="row" id="servicesContainer">
                      {% for p in products %}
                      <div class="col-xl-3 col-lg-4 col-md-6 mb-3 service-card">
                        <div class="card h-100 shadow-sm">
                          <div class="card-body p-2">
                            <div class="d-flex align-items-start">
                              {% if p.services_image %}
                                <img src="{{ p.services_image.url }}" alt="{{ p.services_name }}" 
                                     class="img-fluid rounded mr-2" style="width: 70px; height: 70px; object-fit: cover;">
                              {% else %}
                                <img src="{% static 'no-image.jpg' %}" 
                                     class="img-fluid rounded mr-2" style="width: 70px; height: 70px; object-fit: cover;">
                              {% endif %}
                              <div class="flex-grow-1">
                                <h6 class="card-title mb-1 text-truncate" title="{{ p.services_name }}">
                                  {{ p.services_name }}
                                </h6>
                                <div class="price-container mb-1">
                                  <span class="regular-price text-muted" style="display: block;">
                                    <del>₹{{ p.services_price }}</del>
                                  </span>
                                  <span class="membership-price text-success font-weight-bold" style="display: none;">
                                    ₹{{ p.membership_price }}
                                  </span>
                                  <span class="single-price text-success font-weight-bold">
                                    ₹{{ p.services_price }}
                                  </span>
                                </div>
                                <div class="d-flex align-items-center justify-content-between">
                                  <div class="form-check mb-0">
                                    <input type="checkbox" name="products" value="{{ p.id }}" 
                                           class="form-check-input product-checkbox" 
                                           id="product_{{ p.id }}"
                                           data-regular-price="{{ p.services_price }}"
                                           data-membership-price="{{ p.membership_price }}"
                                           {% if p.id|stringformat:"s" in request.POST.products %}checked{% endif %}>
                                    <label class="form-check-label small" for="product_{{ p.id }}">Select</label>
                                  </div>
                                  <div class="quantity-container" style="width: 80px;">
                                    <input type="number" name="quantity_{{ p.id }}" 
                                           data-product="{{ p.id }}" 
                                           min="1" value="{% if request.POST.quantity %}{{ request.POST.quantity }}{% else %}1{% endif %}" 
                                           class="form-control form-control-sm quantity-input" 
                                           disabled>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- Mobile View (Swipe/Slide Carousel) -->
                  <div class="d-md-none">
                    <!-- Mobile Search Bar -->
                    <div class="px-3 pt-3">
                      <div class="input-group input-group-sm">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                        <input type="text" class="form-control" id="mobileServiceSearch" placeholder="Search services...">
                        <div class="input-group-append">
                          <button class="btn btn-outline-secondary" type="button" id="mobileClearSearch">
                            <i class="fas fa-times"></i>
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- Service Count Badge -->
                    <div class="d-flex justify-content-between align-items-center px-3 mt-2">
                      <span class="text-muted small"><i class="fas fa-chevron-left mr-1"></i>Swipe to browse<i class="fas fa-chevron-right ml-1"></i></span>
                      <span class="badge badge-info">Total: {{ products|length }}</span>
                    </div>

                    <!-- Swipeable Carousel Container -->
                    <div class="service-carousel-container position-relative mt-2">
                      <!-- Left Gradient -->
                      <div class="carousel-gradient-left"></div>
                      
                      <!-- Right Gradient -->
                      <div class="carousel-gradient-right"></div>
                      
                      <!-- Swipeable Cards Container -->
                      <div class="service-cards-wrapper overflow-auto" id="serviceCardsWrapper">
                        <div class="service-cards-row d-flex flex-nowrap px-3" id="servicesCarousel">
                          {% for p in products %}
                          <div class="service-card-mobile mr-3" style="min-width: 280px; max-width: 280px;" data-service-id="{{ p.id }}" data-service-name="{{ p.services_name|lower }}">
                            <div class="card h-100 shadow-sm">
                              <div class="card-body p-2">
                                <div class="d-flex">
                                  <!-- Service Image -->
                                  <div class="mr-2">
                                    {% if p.services_image %}
                                      <img src="{{ p.services_image.url }}" alt="{{ p.services_name }}" 
                                           class="img-fluid rounded" style="width: 80px; height: 80px; object-fit: cover;">
                                    {% else %}
                                      <img src="{% static 'no-image.jpg' %}" 
                                           class="img-fluid rounded" style="width: 80px; height: 80px; object-fit: cover;">
                                    {% endif %}
                                  </div>
                                  
                                  <!-- Service Details -->
                                  <div class="flex-grow-1">
                                    <h6 class="card-title mb-1 font-weight-bold" style="font-size: 0.95rem;">
                                      {{ p.services_name|truncatechars:25 }}
                                    </h6>
                                    
                                    <!-- Price Display -->
                                    <div class="price-container mb-2">
                                      <span class="regular-price text-muted" style="display: block; font-size: 0.8rem;">
                                        <del>₹{{ p.services_price }}</del>
                                      </span>
                                      <span class="membership-price text-success font-weight-bold" style="display: none; font-size: 1rem;">
                                        ₹{{ p.membership_price }}
                                      </span>
                                      <span class="single-price text-success font-weight-bold" style="font-size: 1rem;">
                                        ₹{{ p.services_price }}
                                      </span>
                                    </div>
                                    
                                    <!-- Selection Controls -->
                                    <div class="d-flex align-items-center justify-content-between">
                                      <div class="form-check mb-0">
                                        <input type="checkbox" name="products" value="{{ p.id }}" 
                                               class="form-check-input product-checkbox-mobile" 
                                               id="mobile_product_{{ p.id }}"
                                               data-regular-price="{{ p.services_price }}"
                                               data-membership-price="{{ p.membership_price }}">
                                        <label class="form-check-label small" for="mobile_product_{{ p.id }}">Select</label>
                                      </div>
                                      <div class="quantity-container" style="width: 70px;">
                                        <input type="number" name="quantity_{{ p.id }}" 
                                               data-product="{{ p.id }}" 
                                               min="1" value="1" 
                                               class="form-control form-control-sm quantity-input-mobile" 
                                               disabled>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                      </div>
                    </div>

                    <!-- No Results Message for Mobile -->
                    <div id="mobileNoResults" class="alert alert-warning text-center mx-3 mt-3" style="display: none;">
                      <i class="fas fa-search mr-2"></i>No services found matching your search.
                    </div>

                    <!-- Selected Services Summary for Mobile -->
                    <div class="selected-services-summary mt-3 mx-3 p-2 bg-light rounded" id="mobileSelectedSummary" style="display: none;">
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="font-weight-bold">
                          <i class="fas fa-check-circle text-success mr-1"></i>
                          Selected: <span id="mobileSelectedCount">0</span> service(s)
                        </span>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="viewSelectedBtn">
                          View <i class="fas fa-chevron-down ml-1"></i>
                        </button>
                      </div>
                      <div class="selected-services-list mt-2" id="selectedServicesList" style="display: none;">
                        <!-- Selected services will be listed here dynamically -->
                      </div>
                    </div>
                  </div>

                  <!-- Error container for services (both views) -->
                  <div id="services-error" class="alert alert-danger mt-3 mx-3" style="display: none;">
                    Please select at least one service
                  </div>
                  
                  <!-- Desktop No Results Message -->
                  <div id="noResults" class="alert alert-warning text-center d-none d-md-block" style="display: none;">
                    <i class="fas fa-search mr-2"></i>No services found matching your search.
                  </div>
                {% else %}
                  <div class="alert alert-warning text-center m-3">
                    <i class="fas fa-exclamation-triangle mr-2"></i>No services available.
                  </div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Order Summary with Amount Paid -->
          <div class="card mb-4">
            <div class="card-header d-flex align-items-center">
              <i class="fas fa-receipt mr-2"></i>
              <h6 class="mb-0 flex-grow-1">Order Summary</h6>
            </div>
            <div class="card-body">
              <!-- Mobile-friendly summary table -->
              <div class="table-responsive">
                <table class="table table-sm mb-3">
                  <thead class="thead-light">
                    <tr>
                      <th>Service</th>
                      <th class="text-center">Qty</th>
                      <th class="text-right d-none d-sm-table-cell">Price Type</th>
                      <th class="text-right d-none d-sm-table-cell">Price</th>
                      <th class="text-right">Total</th>
                    </tr>
                  </thead>
                  <tbody id="summary-table">
                    <tr><td colspan="5" class="text-center">No services selected</td></tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Amount Paid Section - Mobile Responsive -->
              <div class="row">
                <div class="col-md-7">
                  <!-- Left side empty -->
                </div>
                <div class="col-md-5">
                  <div class="card bg-light">
                    <div class="card-body">
                      <!-- Service Totals -->
                      <div class="d-flex justify-content-between mb-2">
                        <span class="font-weight-bold">Subtotal:</span>
                        <span>₹<span id="subtotal-amount">0.00</span></span>
                      </div>
                      <div class="d-flex justify-content-between mb-2">
                        <span class="font-weight-bold">Tax (0%):</span>
                        <span>₹<span id="tax-amount">0.00</span></span>
                      </div>
                      <div class="d-flex justify-content-between mb-2" id="discount-section" style="display: none;">
                        <span class="font-weight-bold text-success">Membership Discount:</span>
                        <span class="text-success">-₹<span id="discount-amount">0.00</span></span>
                      </div>
                      <hr class="my-2">
                      <div class="d-flex justify-content-between mb-3">
                        <span class="h5 mb-0">Total:</span>
                        <span class="h5 mb-0 text-success">₹<span id="total-amount">0.00</span></span>
                      </div>
                      
                      <!-- Amount Paid Input -->
                      <div class="form-group mb-3">
                        <label class="font-weight-bold">
                          <i class="fas fa-money-bill-wave mr-1"></i>Amount Paid (₹)
                        </label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="input-group-text">₹</span>
                          </div>
                          <input type="number" 
                                 name="amount_paid" 
                                 id="amount_paid" 
                                 class="form-control form-control-lg" 
                                 min="0" 
                                 step="0.01" 
                                 value="0.00"
                                 placeholder="Enter amount received">
                        </div>
                      </div>
                      
                      <!-- Payment Summary - Mobile Responsive -->
                      <div class="payment-summary mt-3 pt-3 border-top">
                        <div class="d-flex justify-content-between mb-2 text-info">
                          <span class="font-weight-bold">Amount Paid:</span>
                          <span class="font-weight-bold">₹<span id="paid-amount-display">0.00</span></span>
                        </div>
                        
                        <!-- Balance Due -->
                        <div class="d-flex justify-content-between mb-2 text-danger" id="balance-section">
                          <span class="font-weight-bold">Balance Due:</span>
                          <span class="font-weight-bold" id="balance-due">₹0.00</span>
                        </div>
                        
                        <!-- Change Return -->
                        <div class="d-flex justify-content-between mb-2 text-success" id="change-section" style="display: none;">
                          <span class="font-weight-bold">Change Return:</span>
                          <span class="font-weight-bold" id="change-amount">₹0.00</span>
                        </div>
                        
                        <!-- Discount Given -->
                        <div class="d-flex justify-content-between mb-2 text-warning" id="discount-paid-section" style="display: none;">
                          <span class="font-weight-bold">Discount Given:</span>
                          <span class="font-weight-bold" id="discount-paid-amount">₹0.00</span>
                        </div>
                        
                        <!-- Payment Status Badge -->
                        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mt-2">
                          <span class="font-weight-bold mb-1 mb-sm-0">Payment Status:</span>
                          <span class="badge badge-secondary p-2" id="payment-status-badge">Unpaid</span>
                        </div>
                      </div>
                      
                      <small class="text-muted d-block mt-2 text-center text-sm-left" id="total-words">Zero Rupees Only</small>
                      <small class="text-muted d-block mt-1 text-center text-sm-left" id="price-type-indicator">
                        <i class="fas fa-info-circle"></i> Using regular prices
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Submit Buttons - Mobile Responsive -->
          <div class="text-center">
            <button type="submit" class="btn btn-success btn-lg px-4 px-md-5 mb-2 w-100 w-sm-auto">
              <i class="fas fa-file-invoice-dollar mr-2"></i>
              <span class="d-none d-md-inline">Generate Invoice</span>
              <span class="d-md-none">Generate</span>
            </button>
            <div class="d-flex flex-column flex-sm-row justify-content-center gap-2 mt-2">
              <button type="button" class="btn btn-outline-secondary mb-2 mb-sm-0" onclick="clearForm()">
                <i class="fas fa-redo mr-1"></i>Clear Form
              </button>
              <button type="button" class="btn btn-outline-info" onclick="printPreview()">
                <i class="fas fa-print mr-1"></i>Print Preview
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Carousel Styles -->
<style>
@media (max-width: 767.98px) {
  .service-carousel-container {
    position: relative;
    width: 100%;
  }
  
  .service-cards-wrapper {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding-bottom: 10px;
  }
  
  .service-cards-wrapper::-webkit-scrollbar {
    display: none;
  }
  
  .service-cards-row {
    padding-bottom: 5px;
  }
  
  .service-card-mobile {
    transition: transform 0.2s ease;
    scroll-snap-align: start;
  }
  
  .service-card-mobile:active {
    transform: scale(0.98);
  }
  
  .carousel-gradient-left,
  .carousel-gradient-right {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 30px;
    pointer-events: none;
    z-index: 2;
    transition: opacity 0.3s ease;
  }
  
  .carousel-gradient-left {
    left: 0;
    background: linear-gradient(to right, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 100%);
  }
  
  .carousel-gradient-right {
    right: 0;
    background: linear-gradient(to left, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 100%);
  }
  
  .carousel-gradient-left.hidden,
  .carousel-gradient-right.hidden {
    opacity: 0;
  }
  
  .selected-services-summary {
    border: 1px solid #e3e6f0;
  }
  
  .selected-services-list {
    max-height: 200px;
    overflow-y: auto;
  }
  
  .selected-service-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    border-bottom: 1px solid #e3e6f0;
    font-size: 0.9rem;
  }
  
  .selected-service-item:last-child {
    border-bottom: none;
  }
  
  .selected-service-item .service-name {
    font-weight: 500;
  }
  
  .selected-service-item .service-price {
    color: #28a745;
    font-weight: bold;
  }
  
  .selected-service-item .remove-service {
    color: #dc3545;
    cursor: pointer;
    padding: 0 0.25rem;
  }
  
  .service-card-mobile .quantity-input-mobile {
    height: 35px;
    font-size: 1rem;
  }
  
  .payment-summary {
    font-size: 0.9rem;
  }
  
  .btn {
    white-space: nowrap;
  }
}
</style>
{% endblock %}

{% block custom_js %}
<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize Select2 for customer search
    $('.select2-customers').select2({
        placeholder: 'Type name or mobile number to search...',
        allowClear: true,
        width: '100%',
        minimumInputLength: 2,
        dropdownParent: $('#existing'),
        templateResult: function(customer) {
            if (!customer.id) return customer.text;
            
            if (customer.customer) {
                var $container = $(
                    '<div class="customer-option d-flex flex-column p-2">' +
                        '<div class="font-weight-bold text-truncate">' + customer.customer.name + '</div>' +
                        '<div class="small text-muted">' +
                            '<div><i class="fas fa-phone fa-xs mr-1"></i>' + customer.customer.number + '</div>' +
                            '<div><i class="fas fa-venus-mars fa-xs mr-1"></i>' + customer.customer.gender + 
                            ' | <i class="fas fa-tag fa-xs mr-1"></i><span class="badge badge-' + (customer.customer.status === 'Membership' ? 'warning' : 'info') + '">' + customer.customer.status + '</span></div>' +
                        '</div>' +
                    '</div>'
                );
                return $container;
            }
            
            return customer.text;
        },
        templateSelection: function(customer) {
            if (!customer.id) return customer.text;
            
            if (customer.customer) {
                return customer.customer.name + ' - ' + customer.customer.number + ' (' + customer.customer.status + ')';
            }
            
            return customer.text;
        }
    });
    
    // Handle customer selection from dropdown
    $('#customer_select').on('change', function() {
        const selectedOption = $(this).find('option:selected');
        const customerId = selectedOption.val();
        const customerStatus = selectedOption.data('status') || 'Normal';
        
        if (customerId) {
            // Fill customer details from data attributes
            $('#customer_name_display').val(selectedOption.data('name') || '');
            $('#customer_number').val(selectedOption.data('number') || '');
            $('#customer_gender').val(selectedOption.data('gender') || '');
            $('#customer_status').val(customerStatus);
            $('#selected_customer_id').val(customerId);
            $('#customer_status_value').val(customerStatus);
            
            $('#customerDetailsCard').slideDown();
            
            // Show/hide price type selection based on customer status
            updatePriceTypeSection(customerStatus);
            
            // Clear any existing error
            $('#customer_select').removeClass('is-invalid');
        } else {
            clearCustomerDetails();
            $('#customerDetailsCard').slideUp();
            $('#priceTypeSection').hide();
        }
    });
    
    // Handle new customer status change
    $('#new_customer_status').on('change', function() {
        const status = $(this).val();
        updatePriceTypeSection(status);
    });
    
    function clearCustomerDetails() {
        $('#customer_name_display').val('');
        $('#customer_number').val('');
        $('#customer_gender').val('');
        $('#customer_status').val('');
        $('#selected_customer_id').val('');
        $('#customer_status_value').val('Normal');
    }
    
    function updatePriceTypeSection(customerStatus) {
        if (customerStatus === 'Membership') {
            $('#priceTypeSection').slideDown();
            updateServicePrices();
        } else {
            $('#priceTypeSection').slideUp();
            // Reset to regular prices
            $('input[name="price_type"][value="regular"]').prop('checked', true);
            updateServicePrices();
        }
    }
    
    // Handle price type radio button change
    $('input[name="price_type"]').on('change', function() {
        updateServicePrices();
        updateSummary();
    });
    
    function updateServicePrices() {
        const customerStatus = getCustomerStatus();
        const priceType = $('input[name="price_type"]:checked').val();
        
        $('.service-card, .service-card-mobile').each(function() {
            const regularPrice = $(this).find('.regular-price');
            const membershipPrice = $(this).find('.membership-price');
            const singlePrice = $(this).find('.single-price');
            
            if (customerStatus === 'Membership') {
                regularPrice.show();
                membershipPrice.show();
                
                if (priceType === 'membership') {
                    singlePrice.hide();
                    membershipPrice.removeClass('text-muted').addClass('text-success font-weight-bold');
                    regularPrice.find('del').show();
                } else {
                    membershipPrice.hide();
                    singlePrice.show().text('₹' + regularPrice.find('del').text().replace('₹', ''));
                    regularPrice.find('del').show();
                }
            } else {
                // Normal customer
                regularPrice.hide();
                membershipPrice.hide();
                singlePrice.show().text('₹' + regularPrice.find('del').text().replace('₹', ''));
            }
        });
    }
    
    function getCustomerStatus() {
        if ($('#new-tab').hasClass('active')) {
            return $('#new_customer_status').val();
        } else {
            return $('#customer_status_value').val();
        }
    }
    
    // Tab switching logic
    $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
        const targetTab = $(e.target).attr('href');
        
        if (targetTab === '#new') {
            // Switching to new customer tab
            $('.select2-customers').val(null).trigger('change');
            $('#customerDetailsCard').slideUp();
            
            // Set default values for new customer
            $('select[name="new_customer_gender"]').val('Male');
            $('select[name="new_customer_status"]').val('Normal');
            
            // Update price section based on default status
            updatePriceTypeSection('Normal');
        } else if (targetTab === '#existing') {
            // Switching to existing customer tab
            // Clear new customer form
            $('input[name="new_customer_name"]').val('');
            $('input[name="new_customer_mobile"]').val('');
            $('select[name="new_customer_gender"]').val('Male');
            $('select[name="new_customer_status"]').val('Normal');
            
            // Update price section based on selected customer or default
            const selectedStatus = $('#customer_status_value').val();
            updatePriceTypeSection(selectedStatus || 'Normal');
        }
        
        // Update service prices
        updateServicePrices();
        
        // Clear all errors
        $('.alert-danger').hide();
        $('.is-invalid').removeClass('is-invalid');
    });
    
    // Desktop service search
    $('#serviceSearch').on('keyup', function() {
        const searchTerm = $(this).val().toLowerCase();
        let visibleCount = 0;
        
        $('.service-card').each(function() {
            const serviceName = $(this).find('.card-title').text().toLowerCase();
            if (serviceName.includes(searchTerm)) {
                $(this).show();
                visibleCount++;
            } else {
                $(this).hide();
            }
        });
        
        if (visibleCount === 0 && searchTerm.length > 0) {
            $('#noResults').show();
        } else {
            $('#noResults').hide();
        }
    });
    
    $('#clearSearch').on('click', function() {
        $('#serviceSearch').val('').trigger('keyup');
        $('#serviceSearch').focus();
    });
    
    // Mobile carousel functionality
    if ($(window).width() < 768) {
        initializeMobileCarousel();
    }
    
    function initializeMobileCarousel() {
        const wrapper = $('#serviceCardsWrapper');
        const leftGradient = $('.carousel-gradient-left');
        const rightGradient = $('.carousel-gradient-right');
        
        // Update gradient visibility on scroll
        wrapper.on('scroll', function() {
            const scrollLeft = $(this).scrollLeft();
            const maxScroll = $(this)[0].scrollWidth - $(this).width();
            
            if (scrollLeft <= 5) {
                leftGradient.addClass('hidden');
            } else {
                leftGradient.removeClass('hidden');
            }
            
            if (scrollLeft >= maxScroll - 5) {
                rightGradient.addClass('hidden');
            } else {
                rightGradient.removeClass('hidden');
            }
        }).trigger('scroll');
        
        // Mobile search
        $('#mobileServiceSearch').on('keyup', function() {
            const searchTerm = $(this).val().toLowerCase().trim();
            let visibleCount = 0;
            
            $('.service-card-mobile').each(function() {
                const serviceName = $(this).data('service-name') || '';
                if (serviceName.includes(searchTerm) || searchTerm === '') {
                    $(this).show();
                    visibleCount++;
                } else {
                    $(this).hide();
                }
            });
            
            if (visibleCount === 0 && searchTerm.length > 0) {
                $('#mobileNoResults').show();
                $('.carousel-gradient-left, .carousel-gradient-right').hide();
            } else {
                $('#mobileNoResults').hide();
                $('.carousel-gradient-left, .carousel-gradient-right').show();
            }
        });
        
        $('#mobileClearSearch').on('click', function() {
            $('#mobileServiceSearch').val('').trigger('keyup');
            $('#mobileServiceSearch').focus();
        });
    }
    
    // Product selection logic (Desktop)
    $(document).on('change', '.product-checkbox', function() {
        const id = $(this).val();
        const qtyInput = $(`.quantity-input[data-product="${id}"]`);
        
        if ($(this).is(':checked')) {
            qtyInput.prop('disabled', false).val(1);
            $(this).closest('.card').addClass('border-success');
        } else {
            qtyInput.prop('disabled', true).val(1);
            $(this).closest('.card').removeClass('border-success');
        }
        updateSummary();
    });
    
    // Mobile product selection
    $(document).on('change', '.product-checkbox-mobile', function() {
        const id = $(this).val();
        const qtyInput = $(`.quantity-input-mobile[data-product="${id}"]`);
        const desktopCheckbox = $(`#product_${id}`);
        
        if ($(this).is(':checked')) {
            qtyInput.prop('disabled', false).val(1);
            $(this).closest('.card').addClass('border-success');
            desktopCheckbox.prop('checked', true).trigger('change');
        } else {
            qtyInput.prop('disabled', true).val(1);
            $(this).closest('.card').removeClass('border-success');
            desktopCheckbox.prop('checked', false).trigger('change');
        }
        
        updateMobileSelectedSummary();
        updateSummary();
    });
    
    // Quantity inputs
    $(document).on('input', '.quantity-input, .quantity-input-mobile', function() {
        const val = parseInt($(this).val());
        if (val < 1 || isNaN(val)) {
            $(this).val(1);
        }
        updateSummary();
    });
    
    // Update mobile selected summary
    function updateMobileSelectedSummary() {
        const selectedCount = $('.product-checkbox-mobile:checked').length;
        
        if (selectedCount > 0) {
            $('#mobileSelectedSummary').show();
            $('#mobileSelectedCount').text(selectedCount);
            
            let listHtml = '';
            $('.product-checkbox-mobile:checked').each(function() {
                const card = $(this).closest('.service-card-mobile');
                const serviceName = card.find('.card-title').text().trim();
                const price = $(this).data('regular-price');
                const qty = $(`.quantity-input-mobile[data-product="${$(this).val()}"]`).val();
                const total = price * qty;
                
                listHtml += `
                    <div class="selected-service-item">
                        <div>
                            <span class="service-name">${serviceName}</span>
                            <br>
                            <small class="text-muted">Qty: ${qty} x ₹${price}</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="service-price mr-2">₹${total.toFixed(2)}</span>
                            <span class="remove-service" data-id="${$(this).val()}">
                                <i class="fas fa-times"></i>
                            </span>
                        </div>
                    </div>
                `;
            });
            
            $('#selectedServicesList').html(listHtml);
        } else {
            $('#mobileSelectedSummary').hide();
            $('#selectedServicesList').hide();
            $('#viewSelectedBtn').html('View <i class="fas fa-chevron-down ml-1"></i>');
        }
    }
    
    // Toggle selected services list
    $('#viewSelectedBtn').on('click', function() {
        const list = $('#selectedServicesList');
        if (list.is(':visible')) {
            list.slideUp();
            $(this).html('View <i class="fas fa-chevron-down ml-1"></i>');
        } else {
            list.slideDown();
            $(this).html('Hide <i class="fas fa-chevron-up ml-1"></i>');
        }
    });
    
    // Remove service from selected
    $(document).on('click', '.remove-service', function() {
        const id = $(this).data('id');
        $(`#mobile_product_${id}`).prop('checked', false).trigger('change');
        $(`#product_${id}`).prop('checked', false).trigger('change');
    });
    
    // Handle paid amount input
    $('#amount_paid').on('input', function() {
        updatePaymentSummary();
    });
    
    function updatePaymentSummary() {
        const total = parseFloat($('#total-amount').text()) || 0;
        const paid = parseFloat($('#amount_paid').val()) || 0;
        
        $('#paid-amount-display').text(paid.toFixed(2));
        
        if (paid >= total) {
            if (paid > total) {
                const change = paid - total;
                $('#balance-section').hide();
                $('#discount-paid-section').hide();
                $('#change-section').show();
                $('#change-amount').text('₹' + change.toFixed(2));
                $('#payment-status-badge').text('Paid (Excess)').removeClass('badge-secondary badge-warning').addClass('badge-success');
            } else {
                $('#balance-section').hide();
                $('#change-section').hide();
                $('#discount-paid-section').hide();
                $('#payment-status-badge').text('Fully Paid').removeClass('badge-secondary badge-warning').addClass('badge-success');
            }
        } else if (paid > 0 && paid < total) {
            const balance = total - paid;
            $('#balance-section').show();
            $('#balance-due').text('₹' + balance.toFixed(2));
            $('#change-section').hide();
            
            const subtotal = parseFloat($('#subtotal-amount').text()) || 0;
            const membershipDiscount = parseFloat($('#discount-amount').text()) || 0;
            
            if (membershipDiscount > 0) {
                $('#discount-paid-section').hide();
            } else {
                $('#discount-paid-section').show();
                $('#discount-paid-amount').text('₹' + (total - paid).toFixed(2));
            }
            
            $('#payment-status-badge').text('Partially Paid').removeClass('badge-secondary badge-success').addClass('badge-warning');
        } else {
            $('#balance-section').show();
            $('#balance-due').text('₹' + total.toFixed(2));
            $('#change-section').hide();
            
            const membershipDiscount = parseFloat($('#discount-amount').text()) || 0;
            if (membershipDiscount > 0) {
                $('#discount-paid-section').show();
                $('#discount-paid-amount').text('₹' + membershipDiscount.toFixed(2));
            } else {
                $('#discount-paid-section').hide();
            }
            
            $('#payment-status-badge').text('Unpaid').removeClass('badge-success badge-warning').addClass('badge-secondary');
        }
    }
    
    // Update order summary
    function updateSummary() {
        let subtotal = 0;
        let regularSubtotal = 0;
        let html = '';
        let itemCount = 0;
        const customerStatus = getCustomerStatus();
        const priceType = $('input[name="price_type"]:checked').val();
        const isMembershipPrice = customerStatus === 'Membership' && priceType === 'membership';
        
        $('.product-checkbox:checked').each(function() {
            const id = $(this).val();
            const card = $(this).closest('.card-body');
            const name = card.find('.card-title').text().trim();
            
            const regularPrice = parseFloat($(this).data('regular-price')) || 0;
            const membershipPrice = parseFloat($(this).data('membership-price')) || 0;
            
            let price = regularPrice;
            let priceTypeText = 'Regular';
            
            if (isMembershipPrice) {
                price = membershipPrice;
                priceTypeText = 'Membership';
            }
            
            const qty = parseInt($(`.quantity-input[data-product="${id}"]`).val()) || 1;
            const itemTotal = price * qty;
            const regularItemTotal = regularPrice * qty;
            
            subtotal += itemTotal;
            regularSubtotal += regularItemTotal;
            itemCount++;
            
            html += `
                <tr>
                    <td class="align-middle">
                        <div class="text-truncate" style="max-width: 150px;" title="${name}">
                            ${name}
                        </div>
                        <small class="d-sm-none text-muted">${priceTypeText} | ₹${price}</small>
                    </td>
                    <td class="text-center align-middle">${qty}</td>
                    <td class="text-right align-middle d-none d-sm-table-cell">
                        <span class="badge badge-${priceTypeText === 'Membership' ? 'warning' : 'info'}">
                            ${priceTypeText}
                        </span>
                    </td>
                    <td class="text-right align-middle d-none d-sm-table-cell">₹${price.toFixed(2)}</td>
                    <td class="text-right align-middle font-weight-bold">₹${itemTotal.toFixed(2)}</td>
                </tr>
            `;
        });
        
        if (itemCount === 0) {
            html = '<tr><td colspan="5" class="text-center py-3">No services selected</td></tr>';
        }
        
        $('#summary-table').html(html);
        $('#subtotal-amount').text(subtotal.toFixed(2));
        
        const taxRate = 0;
        const taxAmount = subtotal * taxRate;
        
        let discountAmount = 0;
        if (isMembershipPrice && regularSubtotal > 0) {
            discountAmount = regularSubtotal - subtotal;
        }
        
        const totalAmount = subtotal + taxAmount;
        
        $('#tax-amount').text(taxAmount.toFixed(2));
        
        if (discountAmount > 0) {
            $('#discount-section').show();
            $('#discount-amount').text(discountAmount.toFixed(2));
        } else {
            $('#discount-section').hide();
        }
        
        $('#total-amount').text(totalAmount.toFixed(2));
        $('#total-words').text(numberToWords(totalAmount) + ' Only');
        
        let priceTypeIndicator = 'Using regular prices';
        if (isMembershipPrice) {
            priceTypeIndicator = 'Using membership prices (discounted)';
        }
        $('#price-type-indicator').html('<i class="fas fa-info-circle"></i> ' + priceTypeIndicator);
        
        updatePaymentSummary();
    }
    
    // Number to words function
    function numberToWords(num) {
        if (num === 0) return 'Zero';
        
        const units = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
        const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
        const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        
        function convert(n) {
            if (n < 10) return units[n];
            if (n < 20) return teens[n - 10];
            if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? ' ' + units[n % 10] : '');
            if (n < 1000) return units[Math.floor(n / 100)] + ' Hundred' + (n % 100 ? ' and ' + convert(n % 100) : '');
            
            const thousands = Math.floor(n / 1000);
            const remainder = n % 1000;
            let result = convert(thousands) + ' Thousand';
            if (remainder > 0) {
                result += ' ' + convert(remainder);
            }
            return result;
        }
        
        const rupees = Math.floor(num);
        const paise = Math.round((num - rupees) * 100);
        
        let result = convert(rupees) + ' Rupees';
        if (paise > 0) {
            result += ' and ' + convert(paise) + ' Paise';
        }
        
        return result;
    }
    
    // Form validation on submit
    $('#invoiceForm').submit(function(e) {
        e.preventDefault();
        
        let isValid = true;
        let errorMessage = '';
        
        // Clear previous errors
        $('.alert-danger').hide();
        $('.is-invalid').removeClass('is-invalid');
        
        // Validate services (only required field)
        const selectedProducts = $('.product-checkbox:checked').length;
        if (selectedProducts === 0) {
            isValid = false;
            $('#services-error').show();
            errorMessage = 'Please select at least one service.';
        }
        
        if (!isValid) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <div>${errorMessage}</div>
                    </div>
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
            `;
            
            $('.alert').not('.alert-warning').remove();
            $(alertHtml).insertAfter('.card-header');
            
            $('html, body').animate({ scrollTop: 0 }, 500);
            return false;
        }
        
        this.submit();
    });
    
    // Auto-check products that were previously selected
    $('.product-checkbox').each(function() {
        if ($(this).is(':checked')) {
            const id = $(this).val();
            $(`.quantity-input[data-product="${id}"]`).prop('disabled', false);
            $(`.product-checkbox-mobile[value="${id}"]`).prop('checked', true);
            $(`.quantity-input-mobile[data-product="${id}"]`).prop('disabled', false);
            $(this).closest('.card').addClass('border-success');
            $(`.service-card-mobile[data-service-id="${id}"] .card`).addClass('border-success');
        }
    });
    
    // Clear form function
    window.clearForm = function() {
        if (confirm('Are you sure you want to clear the entire form?')) {
            // Clear customer selection
            $('.select2-customers').val(null).trigger('change');
            $('#customerDetailsCard').hide();
            clearCustomerDetails();
            
            // Clear new customer form
            $('input[name="new_customer_name"]').val('');
            $('input[name="new_customer_mobile"]').val('');
            $('select[name="new_customer_gender"]').val('Male');
            $('select[name="new_customer_status"]').val('Normal');
            
            // Clear price type selection
            $('#priceTypeSection').hide();
            $('input[name="price_type"][value="regular"]').prop('checked', true);
            
            // Clear services
            $('.product-checkbox, .product-checkbox-mobile').prop('checked', false).change();
            $('.quantity-input, .quantity-input-mobile').prop('disabled', true).val(1);
            $('.card').removeClass('border-success');
            $('#serviceSearch, #mobileServiceSearch').val('').trigger('keyup');
            
            // Clear comments
            $('textarea[name="comments"]').val('');
            
            // Clear amount paid
            $('#amount_paid').val('0.00');
            
            // Switch to existing customer tab
            $('#existing-tab').tab('show');
            
            // Update service prices and summary
            updateServicePrices();
            updateSummary();
            updateMobileSelectedSummary();
            
            // Clear errors
            $('.alert').remove();
            $('.is-invalid').removeClass('is-invalid');
            
            showToast('Form cleared successfully!', 'success');
        }
    };
    
    // Print preview function
    window.printPreview = function() {
        showToast('Print preview feature coming soon!', 'info');
    };
    
    // Toast notification function
    function showToast(message, type = 'info') {
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="3000">
                <div class="toast-header bg-${type} text-white">
                    <strong class="mr-auto">
                        ${type === 'success' ? '<i class="fas fa-check-circle mr-1"></i>' : 
                          type === 'error' ? '<i class="fas fa-exclamation-circle mr-1"></i>' :
                          '<i class="fas fa-info-circle mr-1"></i>'}
                        ${type.charAt(0).toUpperCase() + type.slice(1)}
                    </strong>
                    <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        $('.toast-container').remove();
        $('body').append('<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>');
        $('.toast-container').html(toastHtml);
        $(`#${toastId}`).toast('show');
    }
    
    // Initialize summary
    updateSummary();
    updateMobileSelectedSummary();
    
    // Handle window resize
    $(window).on('resize', function() {
        if ($(window).width() < 768) {
            initializeMobileCarousel();
        }
    });
});
</script>

<!-- Toast container -->
<div class="toast-container"></div>
{% endblock %}